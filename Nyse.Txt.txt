import yfinance as yf
import pandas as pd
from datetime import date, timedelta

# Top NYSE 50 tickers (update as needed)
tickers = [
    "AAPL", "MSFT", "JNJ", "V", "PG", "JPM", "KO", "DIS", "NVDA", "HD",
    "BAC", "UNH", "VZ", "MRK", "ADBE", "CMCSA", "NFLX", "CSCO", "XOM", "PFE",
    "TMO", "C", "ABT", "ORCL", "CRM", "CVX", "NKE", "LLY", "WMT", "DHR",
    "MCD", "TXN", "INTC", "NEE", "BMY", "LOW", "HON", "QCOM", "SCHW", "MDT",
    "PM", "IBM", "GE", "BA", "CAT", "GILD", "BLK", "AMGN", "BKNG", "COP"
]

start = (date.today() - timedelta(days=15*365)).isoformat()
end = date.today().isoformat()

# Download all tickers in one call (much cleaner and efficient)
print("Downloading data... this may take a few minutes.")
data = yf.download(tickers, start=start, end=end, group_by='ticker', auto_adjust=False, threads=True)

# Restructure multi-index DataFrame into flat format
records = []
for ticker in tickers:
    try:
        if ticker not in data.columns.get_level_values(0):
            print(f"No data for {ticker}")
            continue
        df = data[ticker].copy().reset_index()
        df["SYMBOL"] = ticker
        records.append(df)
        print(f"Processed: {ticker}")
    except Exception as e:
        print(f"Error processing {ticker}: {e}")

# Combine all data into one clean frame
df_final = pd.concat(records, ignore_index=True)
df_final.rename(columns={
    'Date': 'TRADE_DATE',
    'Open': 'OPEN',
    'High': 'HIGH',
    'Low': 'LOW',
    'Close': 'CLOSE',
    'Adj Close': 'ADJCLOSE',
    'Volume': 'VOLUME'
}, inplace=True)

# Save clean structure to CSV
df_final.to_csv('NYSE50_15Y_EQUITY.csv', index=False)
print("CSV successfully saved as NYSE50_15Y_EQUITY.csv")

print(df_final.head())
